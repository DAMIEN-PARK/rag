<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG 라우터 테스트</title>
  <style>
    body { font-family: sans-serif; max-width: 680px; margin: 0 auto; padding: 20px; }
    textarea { width: 100%; min-height: 120px; }
    input[type="url"], input[type="file"] { width: 100%; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
    section { margin-bottom: 32px; }
  </style>
</head>
<body>
  <h1>간단한 RAG 테스트</h1>

  <section>
    <label>API Base URL</label>
    <input id="base" type="url" value="http://localhost:5000" />
  </section>

  <section>
    <h2>LLM 프롬프트</h2>
    <textarea id="prompt" placeholder="질문을 입력하세요"></textarea><br />
    <button id="ask">질의 보내기</button>
    <pre id="askOut"></pre>
  </section>

  <section>
    <h2>파일 업로드</h2>
    <input id="file" type="file" /><br />
    <button id="upload">업로드</button>
    <pre id="upOut"></pre>
  </section>

  <script>
    const $ = (sel) => document.querySelector(sel);
    function base() { return $('#base').value.replace(/\/$/, ''); }

    let uploadedPath = null;
    let processed = false;

    $('#ask').addEventListener('click', async () => {
      // 업로드된 파일이 있고 아직 처리되지 않았다면 실행
      if (uploadedPath && !processed) {
        try {
          const runRes = await fetch(base() + '/api/v1/ingestion/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pdf_path: uploadedPath })
          });
          $('#upOut').textContent = await runRes.text();
          processed = true;
        } catch (e) {
          $('#upOut').textContent = String(e);
        }
      }

      const body = { question: $('#prompt').value };
      try {
        const res = await fetch(base() + '/api/v1/rag/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        $('#askOut').textContent = await res.text();
      } catch (e) {
        $('#askOut').textContent = String(e);
      }
    });

    $('#upload').addEventListener('click', async () => {
      const f = $('#file').files[0];
      if (!f) { alert('파일을 선택하세요'); return; }
      const fd = new FormData();
      fd.append('file', f, f.name);
      try {
        const res = await fetch(base() + '/api/v1/ingestion/upload', {
          method: 'POST',
          body: fd
        });
        const txt = await res.text();
        $('#upOut').textContent = txt;
        try {
          const data = JSON.parse(txt);
          uploadedPath = data.path;
          processed = false;
        } catch {}
      } catch (e) {
        $('#upOut').textContent = String(e);
      }
    });
  </script>
</body>
</html>
